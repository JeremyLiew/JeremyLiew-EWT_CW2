<style>
    :root {
        display: grid;
        grid: auto / 200px 1fr;
        gap: 10px;
    }

    #map {
        border: 1px solid #333;
    }

    #panel {
        background-color: #fff;
        border: 1px solid #999;
        border-radius: 5px;
        margin: 10px;
        padding: 5px;
        font-size: 16px;
    }

    #panel img {
        width: 24px;
    }

    #panel * {
        vertical-align: middle;
    }

    table {
        margin-bottom: 10px;
    }

    td:last-child {
        width: 100%;
    }

    #info {
        font-size: 16px;
        font-family: 'Roboto', sans-serif;
        font-weight: normal;
    }
</style>

<template>
    <main>
        <div>
            <table class="table">
                <tr><td>Latitude </td><td>{{ lat.toFixed(6) }}</td></tr>
                <tr><td>Longitude</td><td>{{ lng.toFixed(6) }}</td></tr>
                <tr><td>Accuracy </td><td>{{ acc.toFixed(3) }} m</td></tr>
            </table>
        </div>
        <div id="map"></div>

        <template>
            <div id="panel">
                <table>
                </table>
            </div>
        </template>
    </main>
</template>

<script>

    app.component({
        data: () => ({
            player: null,
            lat: 0,
            lng: 0,
            acc: 0,
            markers: [],
            students: [],
        }),

        methods: {
            getLocation() {
                const options = {
                    enableHighAccuracy: true,
                };

                navigator.geolocation.getCurrentPosition(
                    this.success,
                    this.fail,
                    options
                );
            },
            success(position) {
                this.lat = position.coords.latitude;
                this.lng = position.coords.longitude;
                this.acc = position.coords.accuracy;

                const p = new gm.LatLng(this.lat, this.lng);
                this.player.setPosition(p);
                map.panTo(p);

                this.saveCoordToCloud()
            },
            fail(error) {
                alert(`ERROR: (${error.code}) ${error.message}`);
            },
            saveCoordToCloud(){
                let payload = {
                    latitude: this.lat,
                    longitude: this.lng,
                    accuracy: this.acc
                }

                STUDENTS.doc(this.$root.user.email).set(payload,{ merge: true });

                console.log(this.$root.user)
            },

            async retrieveUsers() {
                try {
                    const querySnapshot = await STUDENTS.get();
                    querySnapshot.forEach(doc => {
                        const student = doc.data();
                        if (doc.id !== this.$root.user.email.toLowerCase()) {
                            this.students.push(student);
                        }
                    });

                    this.plotMarkers();
                } catch (error) {
                    console.error('Error retrieving users:', error);
                }
            },

            plotMarkers() {
                for (const student of this.students) {
                    const position = new gm.LatLng(student.latitude, student.longitude);
                    const marker = new gm.Marker({
                        map,
                        position,
                        icon: {
                            url: student.photoURL || 'image/photo.png',
                            scaledSize: new gm.Size(34, 34),
                        },
                    });

                    this.markers.push(marker);
                }
            },
        },

        created() {
             if (!this.$root.user) {
                this.$router.push('/sign-in');
                return;
            }else{
                this.$root.title = 'Welcome to Minder !';
            }

            document.title = 'Firebase Authentication : Protected';
        },

        mounted() {
            // ================================================================
            // Google Maps
            // ================================================================
            map = new gm.Map($('#map')[0], {
                center,
                zoom: 16,
                disableDefaultUI: true,
                disableDoubleClickZoom: true,
                clickableIcons: false,
                scaleControl: true,
            });

            const panel = $('#panel')[0];
            panel.index = 0;
            map.controls[gm.ControlPosition.TOP_LEFT].push(panel);

            if(this.$root.user){
                this.player = new gm.Marker({
                    map,
                    animation: gm.Animation.DROP,
                    icon: {
                        url: this.$root.user.photoURL || 'image/photo.png',
                        scaledSize: new gm.Size(34, 34),
                    },
                });
            }

            // gm.event.addListenerOnce(map, 'bounds_changed', e => {
            //     const colors = ['red', 'green', 'blue'];

            //     // TODO(3): Drop markers (hearts) on map within the bounds (random position)
            //     const sw = bounds.getSouthWest();
            //     const sp = bounds.toSpan();

            //     for (const c of colors) {
            //         const p = new gm.LatLng(
            //             sw.lat() + sp.lat() * Math.random(),
            //             sw.lng() + sp.lng() * Math.random()
            //         );
            //         addMarker(p, c);
            //     }

            //     // Call move() to calculate initial distances
            //     this.move();
            // });

            const info = new gm.InfoWindow();

            let timeout = null; // Timeout id

            navigator.permissions.query({ name: 'geolocation' }).then(result => {
                if (result.state == 'granted') {
                    this.getLocation();
                }
            });

            this.retrieveUsers();

            // const addMarker = (position, color) => {
            //     const m = new gm.Marker({
            //         map,
            //         position,
            //         icon: `image/h/${color}.png`,
            //         distance: 0,  // Custom property
            //         found: false, // Custom property
            //         color         // Custom property
            //     });

            //     m.addListener('click', e => {
            //         // TODO(5): Open info window for 3 seconds
            //         info.setContent(`
            //             <div id="info">
            //                 This is the <b>${m.color}</b> heart.<br>
            //                 It is <b>${m.distance.toFixed()}</b> meters away.
            //             </div>
            //         `);
            //         info.open(map, m);

            //         clearTimeout(timeout);
            //         timeout = setTimeout(_ => info.close(), 3000);
            //     });

            //     this.markers.push(m);
            // };
        },

        unmounted() {
            map = null;
        },
    });
</script>