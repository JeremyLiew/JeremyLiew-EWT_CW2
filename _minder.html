<style>
    :root {
        display: grid;
        grid: auto / 200px 1fr;
        gap: 40px;
    }

    #map {
        border: 1px solid #333;
    }

    #panel {
        background-color: #fff;
        border: 1px solid #999;
        border-radius: 5px;
        margin: 10px;
        padding: 5px;
        font-size: 16px;
    }

    #panel img {
        width: 24px;
    }

    #panel * {
        vertical-align: middle;
    }

    table {
        margin-bottom: 10px;
    }

    td:last-child {
        width: 100%;
    }

    #info {
        font-size: 16px;
        font-family: 'Roboto', sans-serif;
        font-weight: normal;
    }
</style>

<template>
    <main>
        <div>
            <table class="table">
                <tr><td>Meter</td><td>
                    <select v-model="meter" @change="change($event, 'meter')">
                        <option disabled value="">Please select one</option>
                        <option value="5000">5000</option>
                        <option value="10000">10000</option>
                        <option value="20000">20000</option>
                        <option value="40000">40000</option>
                        <option value="60000">60000</option>
                        <option value="80000">80000</option>
                    </select>      
                </td></tr>

                <tr><td>Gender</td><td>
                    <select v-model="gender" @change="change($event, 'gender')">
                        <option disabled value="">Please select one</option>
                        <option value="all">All</option>
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                    </select>        
                </td></tr>

                <tr><td>Location </td><td>{{ lat.toFixed(3) }}, {{ lng.toFixed(3) }}</td></tr>
                <button @click="clearMarkers">Clear</button>
            </table>
        </div>

        <div id="map"></div>

        <template>
            <div id="panel">
                <table>
                </table>
            </div>
        </template>
    </main>
</template>

<script>

    app.component({
        data: () => ({
            player: null,
            circle: null,
            meter: '5000',
            gender: 'all',
            lat: 0,
            lng: 0,
            acc: 0,
            markers: [],
            students: [],
        }),

        methods: {
            change(event, field){
                const newValue = event.target.value;

                if (field === 'meter') {
                    this.circle.setRadius(parseInt(newValue));

                } else if (field === 'gender') {
                    this.retrieveUsers();
                }
            },
            getLocation() {
                const options = {
                    enableHighAccuracy: true,
                };

                navigator.geolocation.getCurrentPosition(
                    this.success,
                    this.fail,
                    options
                );
            },
            success(position) {
                this.lat = position.coords.latitude;
                this.lng = position.coords.longitude;
                this.acc = position.coords.accuracy;

                const p = new gm.LatLng(this.lat, this.lng);
                this.player.setPosition(p);
                map.panTo(p);

                if (!this.circle) {
                    this.circle = new gm.Circle({
                        map: map,
                        center: p,
                        radius: parseInt(this.meter) || 0,
                        fillColor: '#AA0000',
                        fillOpacity: 0.35,
                        strokeColor: '#AA0000',
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                    });
                } else {
                    this.circle.setCenter(p);
                }

                this.saveCoordToCloud();
            },
            fail(error) {
                alert(`ERROR: (${error.code}) ${error.message}`);
            },
            saveCoordToCloud(){
                let payload = {
                    latitude: this.lat,
                    longitude: this.lng,
                    accuracy: this.acc
                }

                STUDENTS.doc(this.$root.user.email).set(payload, { merge: true });
            },

            async retrieveUsers() {
                try {
                    this.students = [];
                    let query = STUDENTS;
                    if (this.gender !== 'all') {
                        query = query.where('gender', '==', this.gender);
                    }
                    const querySnapshot = await query.get();

                    querySnapshot.forEach(doc => {
                        const student = doc.data();
                        if (doc.id !== this.$root.user.email.toLowerCase()) {
                            this.students.push(student);
                        }
                    });
                    this.plotMarkers();
                } catch (error) {
                    console.error('Error retrieving users:', error);
                }
            },

            plotMarkers() {
                this.clearMarkers();
                for (const student of this.students) {
                    const position = new gm.LatLng(student.latitude, student.longitude);
                    const marker = new gm.Marker({
                        map,
                        position,
                        icon: {
                            url: student.photoURL || 'image/photo.png',
                            scaledSize: new gm.Size(34, 34),
                        },
                    });

                    this.markers.push(marker);
                }
            },

            clearMarkers() {
                for (let i = 0; i < this.markers.length; i++) {
                    this.markers[i].setVisible(false);
                }
                this.markers = [];
            }
        },

        created() {
            if (!this.$root.user) {
                this.$router.push('/sign-in');
                return;
            } else {
                this.$root.title = 'Welcome to Minder !';
            }

            document.title = 'Firebase Authentication : Protected';
        },

        mounted() {
            map = new gm.Map(document.getElementById('map'), {
                center: { lat: 0, lng: 0 }, // Placeholder center
                zoom: 16,
                disableDefaultUI: true,
                disableDoubleClickZoom: true,
                clickableIcons: false,
                scaleControl: true,
            });

            const panel = document.getElementById('panel');
            panel.index = 0;
            map.controls[gm.ControlPosition.TOP_LEFT].push(panel);

            if (this.$root.user) {
                this.player = new gm.Marker({
                    map,
                    animation: gm.Animation.DROP,
                    icon: {
                        url: this.$root.user.photoURL || 'image/photo.png',
                        scaledSize: new gm.Size(34, 34),
                    },
                });
            }

            const info = new gm.InfoWindow();

            let timeout = null; // Timeout id

            navigator.permissions.query({ name: 'geolocation' }).then(result => {
                if (result.state == 'granted') {
                    this.getLocation();
                }
            });

            this.retrieveUsers();
        },

        unmounted() {
            map = null;
        },
    });
</script>